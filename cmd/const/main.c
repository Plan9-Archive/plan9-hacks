#include <u.h>
#include <libc.h>
#include <bench.h>

#include "fns.h"

struct {
	uchar a, b;
	int r;
} btests[] = {
	0x12, 0x12, 1,
	0x34, 0x34, 1,
	0x56, 0x56, 1,
	0x12, 0x34, 0,
	0x56, 0x78, 0,
	0x90, 0x12, 0,
};

struct {
	uchar a[32], b[32];
	int r;
} ctests[] = {
	{{0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,0x8,0x9,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x30,0x31}, {0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,0x8,0x9,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x30,0x31}, 1},
	{{0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,0x8,0x9,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x30,0x31}, {0x31,0x30,0x29,0x28,0x27,0x26,0x25,0x24,0x23,0x22,0x21,0x20,0x19,0x18,0x17,0x16,0x15,0x14,0x13,0x12,0x11,0x10,0x9,0x8,0x7,0x6,0x5,0x4,0x3,0x2,0x1,0x0}, 0},
};

void
benchbeq(B* b)
{
	int i;

	for(i = 0; i < b->N; i++) {
		constbeq(btests[0].a, btests[0].b);
	}
}

void
benchcmp(B* b)
{
	int i;

	for(i = 0; i < b->N; i++) {
		constcmp(ctests[0].a, ctests[0].b, 32);
	}
}

BItem items[] = {
	"constbeq", benchbeq,
	"constcmp", benchcmp,
};

void
main(void) {
goto runbench;
	uint i, at, r;
	uvlong a, b, over, try, best;

	over = best = -1;

	for(at = 0; at < 1000000; at++) {
		cycles(&a);
		cycles(&b);
		if(over > b-a)
			over = b-a;
	}

	print("constbeq\n");
	for(at = 0; at < 1000000; at++) {
		for(i = 0; i < nelem(btests); i++) {
			cycles(&a);
			r = constbeq(btests[i].a, btests[i].b);
			cycles(&b);
			try = b-a-over;
			if(try < best)
				best = try;
			if(r != btests[i].r)
				print("wrong: %uhhx %uhhx\n", btests[i].a, btests[i].b);
		}
	}
	print("best: %ulld\n", best);

	best = -1;

	print("constcmp\n");

	for(at = 0; at < 1000000; at++) {
		for(i = 0; i < nelem(ctests); i++) {
		
			cycles(&a);
			r = constcmp(ctests[i].a, ctests[i].b, 32);
			cycles(&b);
			try = b-a-over;
			if(try < best)
				best = try;
			if(r != ctests[i].r)
				print("wrong: %uhhx... %uhhx...\n", ctests[i].a[0], ctests[i].b[0]);
		}
	}
	print("best: %ulld\n", best);

runbench:
	benchinit();
	benchitems(items, nelem(items));

	exits(0);
}
